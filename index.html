<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Ordens de Serviço</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        h1 {
            color: #1a73e8;
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .form-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f1f3f4;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        /* Cores por equipe - BORDAS LATERAIS */
        .equipe-1 {
            border-left: 6px solid #1a73e8;
            background-color: #f8fbff;
        }
        
        .equipe-2 {
            border-left: 6px solid #34a853;
            background-color: #f8fff9;
        }
        
        /* Cores por tempo de atraso - FUNDOS COM PADRÕES */
        .atraso-leve {
            background: repeating-linear-gradient(
                45deg,
                rgba(255, 251, 242, 0.3),
                rgba(255, 251, 242, 0.3) 10px,
                rgba(255, 255, 255, 0.3) 10px,
                rgba(255, 255, 255, 0.3) 20px
            ) !important;
        }
        
        .atraso-medio {
            background: repeating-linear-gradient(
                45deg,
                rgba(254, 247, 224, 0.4),
                rgba(254, 247, 224, 0.4) 10px,
                rgba(255, 255, 255, 0.4) 10px,
                rgba(255, 255, 255, 0.4) 20px
            ) !important;
        }
        
        .atraso-grave {
            background: repeating-linear-gradient(
                45deg,
                rgba(252, 232, 230, 0.5),
                rgba(252, 232, 230, 0.5) 10px,
                rgba(255, 255, 255, 0.5) 10px,
                rgba(255, 255, 255, 0.5) 20px
            ) !important;
        }
        
        .atraso-critico {
            background: repeating-linear-gradient(
                45deg,
                rgba(250, 210, 207, 0.6),
                rgba(250, 210, 207, 0.6) 10px,
                rgba(255, 255, 255, 0.6) 10px,
                rgba(255, 255, 255, 0.6) 20px
            ) !important;
            font-weight: bold;
        }
        
        /* Combinando equipe e atraso - cores específicas */
        .equipe-1.atraso-leve {
            border-left: 6px solid #1a73e8;
            background: 
                repeating-linear-gradient(
                    45deg,
                    rgba(232, 240, 254, 0.3),
                    rgba(232, 240, 254, 0.3) 10px,
                    rgba(248, 251, 255, 0.3) 10px,
                    rgba(248, 251, 255, 0.3) 20px
                ),
                #f8fbff !important;
        }
        
        .equipe-1.atraso-medio {
            border-left: 6px solid #1a73e8;
            background: 
                repeating-linear-gradient(
                    45deg,
                    rgba(232, 240, 254, 0.5),
                    rgba(232, 240, 254, 0.5) 10px,
                    rgba(248, 251, 255, 0.5) 10px,
                    rgba(248, 251, 255, 0.5) 20px
                ),
                #f8fbff !important;
        }
        
        .equipe-1.atraso-grave {
            border-left: 6px solid #1a73e8;
            background: 
                repeating-linear-gradient(
                    45deg,
                    rgba(232, 240, 254, 0.7),
                    rgba(232, 240, 254, 0.7) 10px,
                    rgba(248, 251, 255, 0.7) 10px,
                    rgba(248, 251, 255, 0.7) 20px
                ),
                #f8fbff !important;
        }
        
        .equipe-1.atraso-critico {
            border-left: 6px solid #1a73e8;
            background: 
                repeating-linear-gradient(
                    45deg,
                    rgba(232, 240, 254, 0.9),
                    rgba(232, 240, 254, 0.9) 10px,
                    rgba(248, 251, 255, 0.9) 10px,
                    rgba(248, 251, 255, 0.9) 20px
                ),
                #f8fbff !important;
            font-weight: bold;
        }
        
        .equipe-2.atraso-leve {
            border-left: 6px solid #34a853;
            background: 
                repeating-linear-gradient(
                    45deg,
                    rgba(230, 244, 234, 0.3),
                    rgba(230, 244, 234, 0.3) 10px,
                    rgba(248, 255, 249, 0.3) 10px,
                    rgba(248, 255, 249, 0.3) 20px
                ),
                #f8fff9 !important;
        }
        
        .equipe-2.atraso-medio {
            border-left: 6px solid #34a853;
            background: 
                repeating-linear-gradient(
                    45deg,
                    rgba(230, 244, 234, 0.5),
                    rgba(230, 244, 234, 0.5) 10px,
                    rgba(248, 255, 249, 0.5) 10px,
                    rgba(248, 255, 249, 0.5) 20px
                ),
                #f8fff9 !important;
        }
        
        .equipe-2.atraso-grave {
            border-left: 6px solid #34a853;
            background: 
                repeating-linear-gradient(
                    45deg,
                    rgba(230, 244, 234, 0.7),
                    rgba(230, 244, 234, 0.7) 10px,
                    rgba(248, 255, 249, 0.7) 10px,
                    rgba(248, 255, 249, 0.7) 20px
                ),
                #f8fff9 !important;
        }
        
        .equipe-2.atraso-critico {
            border-left: 6px solid #34a853;
            background: 
                repeating-linear-gradient(
                    45deg,
                    rgba(230, 244, 234, 0.9),
                    rgba(230, 244, 234, 0.9) 10px,
                    rgba(248, 255, 249, 0.9) 10px,
                    rgba(248, 255, 249, 0.9) 20px
                ),
                #f8fff9 !important;
            font-weight: bold;
        }
        
        .status-select {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            width: 100%;
        }
        
        .status-pendente {
            border-right: 4px solid #fbbc04;
        }
        
        .status-andamento {
            border-right: 4px solid #4285f4;
        }
        
        .status-concluido {
            border-right: 4px solid #34a853;
        }
        
        .status-atrasado {
            border-right: 4px solid #ea4335;
        }
        
        .legenda {
            display: flex;
            margin-top: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .legenda-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legenda-cor {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .cor-pendente {
            background-color: #fbbc04;
        }
        
        .cor-andamento {
            background-color: #4285f4;
        }
        
        .cor-concluido {
            background-color: #34a853;
        }
        
        .cor-atrasado {
            background-color: #ea4335;
        }
        
        .cor-equipe-1 {
            background-color: #f8fbff;
            border: 2px solid #1a73e8;
        }
        
        .cor-equipe-2 {
            background-color: #f8fff9;
            border: 2px solid #34a853;
        }
        
        .cor-atraso-leve {
            background: repeating-linear-gradient(
                45deg,
                #fffbf2,
                #fffbf2 10px,
                #ffffff 10px,
                #ffffff 20px
            );
            border: 1px solid #f29900;
        }
        
        .cor-atraso-medio {
            background: repeating-linear-gradient(
                45deg,
                #fef7e0,
                #fef7e0 10px,
                #ffffff 10px,
                #ffffff 20px
            );
            border: 1px solid #f29900;
        }
        
        .cor-atraso-grave {
            background: repeating-linear-gradient(
                45deg,
                #fce8e6,
                #fce8e6 10px,
                #ffffff 10px,
                #ffffff 20px
            );
            border: 1px solid #ea4335;
        }
        
        .cor-atraso-critico {
            background: repeating-linear-gradient(
                45deg,
                #fad2cf,
                #fad2cf 10px,
                #ffffff 10px,
                #ffffff 20px
            );
            border: 1px solid #ea4335;
        }
        
        .btn-adicionar {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-adicionar:hover {
            background-color: #0d62d9;
        }
        
        .btn-exportar {
            background-color: #34a853;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-exportar:hover {
            background-color: #2d9249;
        }
        
        input, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .export-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .form-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .filtros {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .filtro-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filtro-group label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
        }
        
        .filtro-select {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            min-width: 150px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .checkbox-group label {
            font-size: 14px;
            font-weight: 500;
            color: #555;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .btn-acoes {
            display: flex;
            gap: 5px;
        }
        
        .btn-editar {
            background-color: #f29900;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-copiar {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-excluir {
            background-color: #ea4335;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a73e8;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .form-modal {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group-modal {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group-modal label {
            font-weight: 500;
            color: #555;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-salvar {
            background-color: #34a853;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-cancelar {
            background-color: #ea4335;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #34a853;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1001;
        }
        
        .toast.erro {
            background-color: #ea4335;
        }
        
        .btn-limpar-filtros {
            background-color: #5f6368;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            align-self: flex-end;
        }
        
        .btn-limpar-filtros:hover {
            background-color: #4a4d52;
        }
        
        .filtros-superiores {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filtros-linha {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .controles-visualizacao {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .form-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            .filtros {
                flex-direction: column;
            }
            
            .btn-acoes {
                flex-direction: column;
            }
            
            .filtros-superiores {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filtros-linha {
                flex-direction: column;
            }
            
            .controles-visualizacao {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            Controle de Ordens de Serviço
            <span style="font-size: 14px; font-weight: normal;">Conectado ao Banco de Dados</span>
        </h1>
        
        <div class="controls">
            <div class="form-column">
                <div class="form-row">
                    <input type="text" id="inputNumeroOrdem" placeholder="Número da Ordem (sistema externo)" style="width: 250px;">
                    <input type="text" id="inputEndereco" placeholder="Endereço do serviço" style="width: 300px;">
                </div>
                <div class="form-row">
                    <select id="selectEquipe" style="width: 200px;">
                        <option value="">Selecione a equipe</option>
                        <option value="Equipe 1">Equipe 1</option>
                        <option value="Equipe 2">Equipe 2</option>
                    </select>
                    <button class="btn-adicionar" id="btnAdicionar">+ Adicionar Ordem</button>
                </div>
            </div>
        </div>
        
        <div class="controles-visualizacao">
            <div class="checkbox-group">
                <input type="checkbox" id="checkOcultarFinalizadas" checked>
                <label for="checkOcultarFinalizadas">Ocultar ordens finalizadas</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="checkMostrarTodas">
                <label for="checkMostrarTodas">Mostrar todas as ordens (incluindo finalizadas)</label>
            </div>
        </div>
        
        <div class="filtros">
            <div class="filtros-superiores">
                <div class="filtros-linha">
                    <div class="filtro-group">
                        <label for="filtroEquipe">Filtrar por Equipe</label>
                        <select id="filtroEquipe" class="filtro-select">
                            <option value="todas">Todas as equipes</option>
                            <option value="Equipe 1">Equipe 1</option>
                            <option value="Equipe 2">Equipe 2</option>
                        </select>
                    </div>
                    
                    <div class="filtro-group">
                        <label for="filtroStatus">Filtrar por Status</label>
                        <select id="filtroStatus" class="filtro-select">
                            <option value="todos">Todos os status</option>
                            <option value="pendente">Pendente</option>
                            <option value="andamento">Em Andamento</option>
                            <option value="atrasado">Em Atraso</option>
                            <option value="concluido">Concluído</option>
                        </select>
                    </div>
                    
                    <div class="filtro-group">
                        <label for="filtroDataInicio">Data Início (De)</label>
                        <input type="date" id="filtroDataInicio" class="filtro-select">
                    </div>
                    
                    <div class="filtro-group">
                        <label for="filtroDataFim">Data Início (Até)</label>
                        <input type="date" id="filtroDataFim" class="filtro-select">
                    </div>
                </div>
                
                <button class="btn-limpar-filtros" id="btnLimparFiltros">Limpar Filtros</button>
            </div>
        </div>
        
        <div class="table-container">
            <table id="tabelaOrdens">
                <thead>
                    <tr>
                        <th width="20%">Nº Ordem</th>
                        <th width="30%">Endereço</th>
                        <th width="15%">Equipe</th>
                        <th width="15%">Data Início</th>
                        <th width="15%">Status</th>
                        <th width="15%">Ações</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    <!-- As linhas serão adicionadas via JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div class="legenda">
            <div class="legenda-item">
                <div class="legenda-cor cor-equipe-1"></div>
                <span>Equipe 1</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor cor-equipe-2"></div>
                <span>Equipe 2</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor cor-pendente"></div>
                <span>Pendente</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor cor-andamento"></div>
                <span>Em Andamento</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor cor-atrasado"></div>
                <span>Em Atraso</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor cor-atraso-leve"></div>
                <span>3-5 dias</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor cor-atraso-medio"></div>
                <span>6-7 dias</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor cor-atraso-grave"></div>
                <span>8-10 dias</span>
            </div>
            <div class="legenda-item">
                <div class="legenda-cor cor-atraso-critico"></div>
                <span>+10 dias</span>
            </div>
        </div>
        
        <div class="export-section">
    <h3>Backup e Restauração</h3>
    <p id="statusConexao">Sistema conectado - {{ordens.length}} ordens carregadas</p>
    
    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
        <button class="btn-exportar" id="btnExportarJSON">Exportar Backup (JSON)</button>
        <button class="btn-exportar" id="btnExportarCSV">Exportar CSV</button>
        <button class="btn-adicionar" id="btnImportar">Importar Backup</button>
        <button class="btn-limpar-filtros" id="btnBackupAutomatico">Backup Automático</button>
    </div>
    
    <div style="margin-top: 15px; font-size: 12px; color: #666;">
        <strong>Backup Automático:</strong> Último backup: <span id="ultimoBackup">Nunca</span>
        <br><strong>Total de ordens:</strong> <span id="totalOrdens">0</span> ordens no sistema
    </div>
    
    <input type="file" id="importFile" accept=".json,.csv" style="display: none;">
</div>

    <!-- Modal para editar ordem -->
    <div class="modal" id="modalEditar">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Editar Ordem de Serviço</div>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <form class="form-modal" id="formEditar">
                <input type="hidden" id="editId">
                <div class="form-group-modal">
                    <label for="editNumeroOrdem">Número da Ordem</label>
                    <input type="text" id="editNumeroOrdem" placeholder="Número da ordem">
                </div>
                <div class="form-group-modal">
                    <label for="editEndereco">Endereço</label>
                    <input type="text" id="editEndereco" placeholder="Endereço do serviço">
                </div>
                <div class="form-group-modal">
                    <label for="editEquipe">Equipe</label>
                    <select id="editEquipe">
                        <option value="">Selecione a equipe</option>
                        <option value="Equipe 1">Equipe 1</option>
                        <option value="Equipe 2">Equipe 2</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancelar" id="btnCancelarEditar">Cancelar</button>
                    <button type="submit" class="btn-salvar">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast para notificações -->
    <div class="toast" id="toast"></div>

    <!-- SUPABASE CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ========== CONFIGURAÇÃO SUPABASE ==========
        const SUPABASE_URL = 'https://vyjwovrhmwbbovqqooae.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5andvdnJobXdiYm92cXFvb2FlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTE5NjAsImV4cCI6MjA3NzkyNzk2MH0._-rBoV77NypZ3oYLPJ65piAYE-my8difewOsxXAb2R8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ========== VARIÁVEIS GLOBAIS ==========
        let ordens = [];

        // ========== FUNÇÕES DO BANCO ==========
        async function carregarOrdens() {
            try {
                console.log('Carregando ordens do Supabase...');
                
                const { data, error } = await supabase
                    .from('ordens')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                console.log('Ordens carregadas:', data?.length || 0);
                ordens = data || [];
                return ordens;
            } catch (error) {
                console.error('Erro ao carregar ordens:', error);
                mostrarToast('Erro ao carregar ordens do banco de dados', 'erro');
                return [];
            }
        }

        async function salvarOrdem(ordem) {
            try {
                console.log('Salvando ordem:', ordem);
                
                const ordemData = {
                    numero_ordem: ordem.numero_ordem || null,
                    endereco: ordem.endereco,
                    equipe: ordem.equipe,
                    data_inicio: ordem.data_inicio || obterDataAtual(),
                    status: ordem.status || 'pendente'
                };
                
                if (ordem.id) {
                    ordemData.id = ordem.id;
                    const { data, error } = await supabase
                        .from('ordens')
                        .upsert(ordemData)
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                } else {
                    const { data, error } = await supabase
                        .from('ordens')
                        .insert(ordemData)
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Erro ao salvar ordem:', error);
                throw error;
            }
        }

        async function excluirOrdem(id) {
            try {
                const { error } = await supabase
                    .from('ordens')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Erro ao excluir ordem:', error);
                throw error;
            }
        }

        async function atualizarStatus(id, novoStatus) {
            try {
                const { data, error } = await supabase
                    .from('ordens')
                    .update({ status: novoStatus })
                    .eq('id', id)
                    .select();
                
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                throw error;
            }
        }

        async function numeroOrdemExiste(numeroOrdem, idExcluir = null) {
            try {
                let query = supabase
                    .from('ordens')
                    .select('id')
                    .eq('numero_ordem', numeroOrdem);
                
                if (idExcluir) {
                    query = query.neq('id', idExcluir);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                return data && data.length > 0;
            } catch (error) {
                console.error('Erro ao verificar número da ordem:', error);
                return false;
            }
        }

        // ========== FUNÇÕES UTILITÁRIAS ==========
        function obterDataAtual() {
            const data = new Date();
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }

        function mostrarToast(mensagem, tipo = 'sucesso') {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = mensagem;
                toast.style.display = 'block';
                toast.className = 'toast';
                
                if (tipo === 'erro') {
                    toast.classList.add('erro');
                }
                
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }
        }

        function mostrarStatus(mensagem) {
            const elemento = document.getElementById('statusConexao');
            if (elemento) {
                elemento.textContent = mensagem;
            }
        }

        function calcularDiasDesdeInicio(dataInicio) {
            const hoje = new Date();
            const inicio = new Date(dataInicio.split('/').reverse().join('-'));
            const diffTime = Math.abs(hoje - inicio);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function obterClasseAtraso(dias) {
            if (dias >= 11) return 'atraso-critico';
            if (dias >= 8) return 'atraso-grave';
            if (dias >= 6) return 'atraso-medio';
            if (dias >= 3) return 'atraso-leve';
            return '';
        }

        function converterParaInputDate(dataString) {
            if (!dataString) return '';
            const partes = dataString.split('/');
            if (partes.length !== 3) return '';
            return `${partes[2]}-${partes[1]}-${partes[0]}`;
        }

        // ========== APLICAÇÃO PRINCIPAL ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Iniciando aplicação...');
            inicializarApp();
        });

        async function inicializarApp() {
    configurarEventos();
    configurarEventosBackup(); // ← NOVA LINHA
    await carregarDadosIniciais();
    renderizarTabela();
    atualizarStatusBackup(); // ← NOVA LINHA
}

        function configurarEventos() {
            console.log('Configurando eventos...');
            
            const btnAdicionar = document.getElementById('btnAdicionar');
            if (btnAdicionar) {
                btnAdicionar.addEventListener('click', adicionarNovaOrdem);
            }
            
            const btnRecarregar = document.getElementById('btnRecarregar');
            if (btnRecarregar) {
                btnRecarregar.addEventListener('click', async () => {
                    await carregarDadosIniciais();
                    renderizarTabela();
                });
            }
            
            const filtros = ['filtroEquipe', 'filtroStatus', 'filtroDataInicio', 'filtroDataFim'];
            filtros.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.addEventListener('change', aplicarFiltros);
                }
            });
            
            const checkOcultar = document.getElementById('checkOcultarFinalizadas');
            const checkMostrar = document.getElementById('checkMostrarTodas');
            
            if (checkOcultar) {
                checkOcultar.addEventListener('change', function() {
                    if (this.checked && checkMostrar) {
                        checkMostrar.checked = false;
                    }
                    aplicarFiltros();
                });
            }
            
            if (checkMostrar) {
                checkMostrar.addEventListener('change', function() {
                    if (this.checked && checkOcultar) {
                        checkOcultar.checked = false;
                    }
                    aplicarFiltros();
                });
            }
            
            const btnLimpar = document.getElementById('btnLimparFiltros');
            if (btnLimpar) {
                btnLimpar.addEventListener('click', limparFiltros);
            }
            
            const formEditar = document.getElementById('formEditar');
            const closeModal = document.getElementById('closeModal');
            const btnCancelar = document.getElementById('btnCancelarEditar');
            
            if (formEditar) formEditar.addEventListener('submit', salvarEdicao);
            if (closeModal) closeModal.addEventListener('click', fecharModalEditar);
            if (btnCancelar) btnCancelar.addEventListener('click', fecharModalEditar);
            
            const modal = document.getElementById('modalEditar');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        fecharModalEditar();
                    }
                });
            }
            
            const inputNumero = document.getElementById('inputNumeroOrdem');
            const inputEndereco = document.getElementById('inputEndereco');
            
            if (inputNumero) {
                inputNumero.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') adicionarNovaOrdem();
                });
            }
            
            if (inputEndereco) {
                inputEndereco.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') adicionarNovaOrdem();
                });
            }
            
            console.log('Eventos configurados');
        }

        async function carregarDadosIniciais() {
            try {
                mostrarStatus('Carregando ordens...');
                await carregarOrdens();
                mostrarStatus(`Sistema conectado - ${ordens.length} ordens carregadas`);
                mostrarToast('Dados carregados com sucesso!');
            } catch (error) {
                console.error('Erro ao carregar dados iniciais:', error);
                mostrarStatus('Erro ao carregar dados');
                mostrarToast('Erro ao carregar ordens', 'erro');
            }
        }

        async function adicionarNovaOrdem() {
            const numeroOrdem = document.getElementById('inputNumeroOrdem').value.trim();
            const endereco = document.getElementById('inputEndereco').value.trim();
            const equipe = document.getElementById('selectEquipe').value;
            
            if (!endereco || !equipe) {
                alert('Por favor, preencha o endereço e selecione a equipe.');
                return;
            }
            
            try {
                if (numeroOrdem && await numeroOrdemExiste(numeroOrdem)) {
                    mostrarToast('Já existe uma ordem com este número!', 'erro');
                    return;
                }
                
                const novaOrdem = {
                    numero_ordem: numeroOrdem || null,
                    endereco: endereco,
                    equipe: equipe,
                    data_inicio: obterDataAtual(),
                    status: "pendente"
                };
                
                const ordemSalva = await salvarOrdem(novaOrdem);
                
                await carregarDadosIniciais();
                renderizarTabela();
                
                document.getElementById('inputNumeroOrdem').value = '';
                document.getElementById('inputEndereco').value = '';
                document.getElementById('selectEquipe').value = '';
                
                mostrarToast('Ordem adicionada com sucesso!');
            } catch (error) {
                console.error('Erro ao adicionar ordem:', error);
                mostrarToast('Erro ao adicionar ordem', 'erro');
            }
        }

        function renderizarTabela() {
            console.log('Renderizando tabela...');
            
            const corpoTabela = document.getElementById('corpoTabela');
            if (!corpoTabela) {
                console.error('Elemento corpoTabela não encontrado!');
                return;
            }
            
            corpoTabela.innerHTML = '';
            
            if (ordens.length === 0) {
                corpoTabela.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">
                            Nenhuma ordem de serviço cadastrada. Adicione uma nova ordem usando o formulário acima.
                        </td>
                    </tr>
                `;
                return;
            }
            
            ordens.sort((a, b) => new Date(b.data_inicio.split('/').reverse().join('-')) - new Date(a.data_inicio.split('/').reverse().join('-')));
            
            ordens.forEach(ordem => {
                const linha = document.createElement('tr');
                
                if (ordem.equipe === 'Equipe 1') {
                    linha.classList.add('equipe-1');
                } else if (ordem.equipe === 'Equipe 2') {
                    linha.classList.add('equipe-2');
                }
                
                linha.classList.add(`status-${ordem.status}`);
                
                if (ordem.status !== 'concluido') {
                    const dias = calcularDiasDesdeInicio(ordem.data_inicio);
                    const classeAtraso = obterClasseAtraso(dias);
                    if (classeAtraso) {
                        linha.classList.add(classeAtraso);
                    }
                }
                
                linha.innerHTML = `
                    <td>${ordem.numero_ordem || '-'}</td>
                    <td>${ordem.endereco}</td>
                    <td>${ordem.equipe}</td>
                    <td>${ordem.data_inicio}</td>
                    <td>
                        <select class="status-select" data-id="${ordem.id}">
                            <option value="pendente" ${ordem.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                            <option value="andamento" ${ordem.status === 'andamento' ? 'selected' : ''}>Em Andamento</option>
                            <option value="atrasado" ${ordem.status === 'atrasado' ? 'selected' : ''}>Em Atraso</option>
                            <option value="concluido" ${ordem.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                        </select>
                    </td>
                    <td>
                        <div class="btn-acoes">
                            <button class="btn-editar" data-id="${ordem.id}">Editar</button>
                            <button class="btn-copiar" data-id="${ordem.id}">Copiar</button>
                            <button class="btn-excluir" data-id="${ordem.id}">Excluir</button>
                        </div>
                    </td>
                `;
                
                corpoTabela.appendChild(linha);
            });
            
            configurarEventosDinamicos();
            aplicarFiltros();
            
            console.log('Tabela renderizada com', ordens.length, 'ordens');
        }

        function configurarEventosDinamicos() {
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', async function() {
                    const idOrdem = this.getAttribute('data-id');
                    const novoStatus = this.value;
                    
                    try {
                        await atualizarStatus(idOrdem, novoStatus);
                        await carregarDadosIniciais();
                        renderizarTabela();
                        mostrarToast('Status atualizado com sucesso!');
                    } catch (error) {
                        console.error('Erro ao atualizar status:', error);
                        mostrarToast('Erro ao atualizar status', 'erro');
                    }
                });
            });
            
            document.querySelectorAll('.btn-editar').forEach(botao => {
                botao.addEventListener('click', function() {
                    const idOrdem = this.getAttribute('data-id');
                    abrirModalEditar(idOrdem);
                });
            });
            
            document.querySelectorAll('.btn-copiar').forEach(botao => {
                botao.addEventListener('click', function() {
                    const idOrdem = this.getAttribute('data-id');
                    const ordem = ordens.find(o => o.id === idOrdem);
                    if (ordem) {
                        copiarInformacoes(ordem);
                    }
                });
            });
            
            document.querySelectorAll('.btn-excluir').forEach(botao => {
                botao.addEventListener('click', async function() {
                    const idOrdem = this.getAttribute('data-id');
                    if (confirm('Tem certeza que deseja excluir esta ordem?')) {
                        try {
                            await excluirOrdem(idOrdem);
                            await carregarDadosIniciais();
                            renderizarTabela();
                            mostrarToast('Ordem excluída com sucesso!');
                        } catch (error) {
                            console.error('Erro ao excluir ordem:', error);
                            mostrarToast('Erro ao excluir ordem', 'erro');
                        }
                    }
                });
            });
        }

        function copiarInformacoes(ordem) {
            const texto = `Ordem: ${ordem.numero_ordem || 'N/A'}\nEndereço: ${ordem.endereco}\nEquipe: ${ordem.equipe}\nData: ${ordem.data_inicio}`;
            
            navigator.clipboard.writeText(texto).then(() => {
                mostrarToast('Informações copiadas para a área de transferência!');
            }).catch(err => {
                console.error('Erro ao copiar: ', err);
                mostrarToast('Erro ao copiar informações', 'erro');
            });
        }

        function abrirModalEditar(idOrdem) {
            const ordem = ordens.find(o => o.id === idOrdem);
            if (!ordem) return;
            
            document.getElementById('editId').value = ordem.id;
            document.getElementById('editNumeroOrdem').value = ordem.numero_ordem || '';
            document.getElementById('editEndereco').value = ordem.endereco;
            document.getElementById('editEquipe').value = ordem.equipe;
            
            document.getElementById('modalEditar').style.display = 'flex';
        }

        function fecharModalEditar() {
            document.getElementById('modalEditar').style.display = 'none';
            document.getElementById('formEditar').reset();
        }

        async function salvarEdicao(e) {
            e.preventDefault();
            
            const id = document.getElementById('editId').value;
            const numeroOrdem = document.getElementById('editNumeroOrdem').value.trim();
            const endereco = document.getElementById('editEndereco').value.trim();
            const equipe = document.getElementById('editEquipe').value;
            
            if (!endereco || !equipe) {
                alert('Por favor, preencha o endereço e selecione a equipe.');
                return;
            }
            
            try {
                if (numeroOrdem && await numeroOrdemExiste(numeroOrdem, id)) {
                    mostrarToast('Já existe uma ordem com este número!', 'erro');
                    return;
                }
                
                const ordemAtualizada = {
                    id: id,
                    numero_ordem: numeroOrdem || null,
                    endereco: endereco,
                    equipe: equipe
                };
                
                await salvarOrdem(ordemAtualizada);
                await carregarDadosIniciais();
                renderizarTabela();
                fecharModalEditar();
                
                mostrarToast('Ordem atualizada com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar edição:', error);
                mostrarToast('Erro ao atualizar ordem', 'erro');
            }
        }

        function limparFiltros() {
            document.getElementById('filtroEquipe').value = 'todas';
            document.getElementById('filtroStatus').value = 'todos';
            document.getElementById('filtroDataInicio').value = '';
            document.getElementById('filtroDataFim').value = '';
            aplicarFiltros();
        }

        function aplicarFiltros() {
            const filtroEquipe = document.getElementById('filtroEquipe').value;
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroDataInicio = document.getElementById('filtroDataInicio').value;
            const filtroDataFim = document.getElementById('filtroDataFim').value;
            const ocultarFinalizadas = document.getElementById('checkOcultarFinalizadas').checked;
            const mostrarTodas = document.getElementById('checkMostrarTodas').checked;
            
            const corpoTabela = document.getElementById('corpoTabela');
            const linhas = corpoTabela.getElementsByTagName('tr');
            
            for (let linha of linhas) {
                let mostrar = true;
                
                if (filtroEquipe !== 'todas') {
                    const celulaEquipe = linha.cells[2];
                    if (celulaEquipe && celulaEquipe.textContent !== filtroEquipe) {
                        mostrar = false;
                    }
                }
                
                if (filtroStatus !== 'todos') {
                    const statusSelect = linha.querySelector('.status-select');
                    if (statusSelect && statusSelect.value !== filtroStatus) {
                        mostrar = false;
                    }
                }
                
                if (filtroDataInicio || filtroDataFim) {
                    const celulaData = linha.cells[3];
                    if (celulaData) {
                        const dataOrdem = converterParaInputDate(celulaData.textContent);
                        
                        if (filtroDataInicio && dataOrdem < filtroDataInicio) {
                            mostrar = false;
                        }
                        
                        if (filtroDataFim && dataOrdem > filtroDataFim) {
                            mostrar = false;
                        }
                    }
                }
                
                if (ocultarFinalizadas && !mostrarTodas) {
                    const statusSelect = linha.querySelector('.status-select');
                    if (statusSelect && statusSelect.value === 'concluido') {
                        mostrar = false;
                    }
                }
                
                linha.style.display = mostrar ? '' : 'none';
            }
        }

        // Testar conexão com Supabase
        supabase.from('ordens').select('count', { count: 'exact' }).then(response => {
            console.log('Conexão com Supabase estabelecida:', !response.error);
        }).catch(error => {
            console.error('Erro na conexão com Supabase:', error);
        });

        // ========== SISTEMA DE BACKUP E EXPORT ==========

// Exportar para JSON
function exportarParaJSON() {
    try {
        const dadosExportacao = {
            metadata: {
                versao: "1.0",
                dataExportacao: new Date().toISOString(),
                totalOrdens: ordens.length,
                sistema: "Controle de Ordens de Serviço"
            },
            ordens: ordens
        };
        
        const dadosJSON = JSON.stringify(dadosExportacao, null, 2);
        const blob = new Blob([dadosJSON], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup-ordens-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Salvar data do último backup
        localStorage.setItem('ultimoBackup', new Date().toISOString());
        atualizarStatusBackup();
        
        mostrarToast(`Backup exportado com ${ordens.length} ordens!`);
    } catch (error) {
        console.error('Erro ao exportar JSON:', error);
        mostrarToast('Erro ao exportar backup', 'erro');
    }
}

// Exportar para CSV
function exportarParaCSV() {
    try {
        if (ordens.length === 0) {
            mostrarToast('Nenhuma ordem para exportar', 'erro');
            return;
        }
        
        const cabecalhos = ['Número Ordem', 'Endereço', 'Equipe', 'Data Início', 'Status', 'ID', 'Data Criação'];
        
        const linhasCSV = ordens.map(ordem => [
            `"${ordem.numero_ordem || ''}"`,
            `"${ordem.endereco}"`,
            `"${ordem.equipe}"`,
            `"${ordem.data_inicio}"`,
            `"${ordem.status}"`,
            `"${ordem.id}"`,
            `"${ordem.created_at}"`
        ].join(','));
        
        const csvContent = [cabecalhos.join(','), ...linhasCSV].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `ordens-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        mostrarToast(`CSV exportado com ${ordens.length} ordens!`);
    } catch (error) {
        console.error('Erro ao exportar CSV:', error);
        mostrarToast('Erro ao exportar CSV', 'erro');
    }
}

// Importar dados
function importarDados() {
    document.getElementById('importFile').click();
}

// Processar arquivo importado
async function processarArquivoImportado(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const conteudo = e.target.result;
                
                if (file.name.endsWith('.json')) {
                    await importarJSON(conteudo);
                } else if (file.name.endsWith('.csv')) {
                    await importarCSV(conteudo);
                } else {
                    throw new Error('Formato de arquivo não suportado');
                }
                
                resolve();
            } catch (error) {
                reject(error);
            }
        };
        
        reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
        reader.readAsText(file);
    });
}

// Importar JSON
async function importarJSON(conteudoJSON) {
    try {
        const dados = JSON.parse(conteudoJSON);
        
        if (!dados.ordens || !Array.isArray(dados.ordens)) {
            throw new Error('Arquivo JSON inválido');
        }
        
        const confirmacao = confirm(
            `Deseja importar ${dados.ordens.length} ordens?\n\n` +
            `Isso irá ADICIONAR as novas ordens ao sistema atual.\n` +
            `Ordens com números duplicados serão ignoradas.`
        );
        
        if (!confirmacao) return;
        
        let ordensImportadas = 0;
        let ordensDuplicadas = 0;
        
        for (const ordem of dados.ordens) {
            try {
                // Verificar se número da ordem já existe
                if (ordem.numero_ordem && await numeroOrdemExiste(ordem.numero_ordem)) {
                    ordensDuplicadas++;
                    continue;
                }
                
                // Preparar dados para importação
                const ordemImportada = {
                    numero_ordem: ordem.numero_ordem || null,
                    endereco: ordem.endereco,
                    equipe: ordem.equipe,
                    data_inicio: ordem.data_inicio,
                    status: ordem.status || 'pendente'
                };
                
                await salvarOrdem(ordemImportada);
                ordensImportadas++;
                
            } catch (error) {
                console.error('Erro ao importar ordem:', ordem, error);
            }
        }
        
        // Recarregar dados
        await carregarDadosIniciais();
        renderizarTabela();
        
        mostrarToast(
            `Importação concluída: ${ordensImportadas} novas ordens, ${ordensDuplicadas} duplicadas ignoradas`
        );
        
    } catch (error) {
        console.error('Erro ao importar JSON:', error);
        mostrarToast('Erro ao importar arquivo JSON', 'erro');
    }
}

// Importar CSV (funcionalidade básica)
async function importarCSV(conteudoCSV) {
    try {
        const linhas = conteudoCSV.split('\n').filter(linha => linha.trim());
        const cabecalhos = linhas[0].split(',').map(h => h.replace(/"/g, '').trim());
        
        const ordensCSV = linhas.slice(1).map(linha => {
            const valores = linha.split(',').map(v => v.replace(/"/g, '').trim());
            const ordem = {};
            
            cabecalhos.forEach((cabecalho, index) => {
                ordem[cabecalho] = valores[index] || '';
            });
            
            return ordem;
        });
        
        const confirmacao = confirm(
            `Deseja importar ${ordensCSV.length} ordens do CSV?\n\n` +
            `Certifique-se de que o CSV tenha as colunas: Número Ordem, Endereço, Equipe, Data Início, Status`
        );
        
        if (!confirmacao) return;
        
        let ordensImportadas = 0;
        
        for (const ordem of ordensCSV) {
            try {
                if (!ordem.endereco || !ordem.equipe) continue;
                
                // Verificar duplicatas
                if (ordem.numero_ordem && await numeroOrdemExiste(ordem.numero_ordem)) {
                    continue;
                }
                
                const ordemImportada = {
                    numero_ordem: ordem.numero_ordem || ordem['Número Ordem'] || null,
                    endereco: ordem.endereco || ordem.Endereço,
                    equipe: ordem.equipe || ordem.Equipe,
                    data_inicio: ordem.data_inicio || ordem['Data Início'] || obterDataAtual(),
                    status: ordem.status || ordem.Status || 'pendente'
                };
                
                await salvarOrdem(ordemImportada);
                ordensImportadas++;
                
            } catch (error) {
                console.error('Erro ao importar ordem do CSV:', ordem, error);
            }
        }
        
        await carregarDadosIniciais();
        renderizarTabela();
        
        mostrarToast(`Importação CSV: ${ordensImportadas} ordens adicionadas`);
        
    } catch (error) {
        console.error('Erro ao importar CSV:', error);
        mostrarToast('Erro ao importar arquivo CSV', 'erro');
    }
}

// Backup automático
function fazerBackupAutomatico() {
    try {
        const dadosBackup = {
            metadata: {
                tipo: "backup_automatico",
                data: new Date().toISOString(),
                totalOrdens: ordens.length
            },
            ordens: ordens
        };
        
        // Salvar no localStorage como backup local
        localStorage.setItem('backupAutomatico', JSON.stringify(dadosBackup));
        localStorage.setItem('ultimoBackup', new Date().toISOString());
        
        atualizarStatusBackup();
        mostrarToast('Backup automático realizado com sucesso!');
        
    } catch (error) {
        console.error('Erro no backup automático:', error);
        mostrarToast('Erro no backup automático', 'erro');
    }
}

// Restaurar backup automático
async function restaurarBackupAutomatico() {
    try {
        const backupSalvo = localStorage.getItem('backupAutomatico');
        if (!backupSalvo) {
            mostrarToast('Nenhum backup local encontrado', 'erro');
            return;
        }
        
        const confirmacao = confirm(
            'Deseja restaurar o último backup automático?\n\n' +
            'Isso substituirá os dados atuais pelo backup.'
        );
        
        if (!confirmacao) return;
        
        await importarJSON(backupSalvo);
        
    } catch (error) {
        console.error('Erro ao restaurar backup:', error);
        mostrarToast('Erro ao restaurar backup', 'erro');
    }
}

// Atualizar status do backup
function atualizarStatusBackup() {
    const ultimoBackup = localStorage.getItem('ultimoBackup');
    const elementoBackup = document.getElementById('ultimoBackup');
    const totalOrdens = document.getElementById('totalOrdens');
    
    if (elementoBackup) {
        if (ultimoBackup) {
            const data = new Date(ultimoBackup);
            elementoBackup.textContent = data.toLocaleString('pt-BR');
        } else {
            elementoBackup.textContent = 'Nunca';
        }
    }
    
    if (totalOrdens) {
        totalOrdens.textContent = ordens.length;
    }
}

// ========== CONFIGURAR EVENTOS DE BACKUP ==========

function configurarEventosBackup() {
    // Botão exportar JSON
    const btnExportarJSON = document.getElementById('btnExportarJSON');
    if (btnExportarJSON) {
        btnExportarJSON.addEventListener('click', exportarParaJSON);
    }
    
    // Botão exportar CSV
    const btnExportarCSV = document.getElementById('btnExportarCSV');
    if (btnExportarCSV) {
        btnExportarCSV.addEventListener('click', exportarParaCSV);
    }
    
    // Botão importar
    const btnImportar = document.getElementById('btnImportar');
    if (btnImportar) {
        btnImportar.addEventListener('click', importarDados);
    }
    
    // Botão backup automático
    const btnBackupAutomatico = document.getElementById('btnBackupAutomatico');
    if (btnBackupAutomatico) {
        btnBackupAutomatico.addEventListener('click', fazerBackupAutomatico);
    }
    
    // Input file para importação
    const importFile = document.getElementById('importFile');
    if (importFile) {
        importFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                processarArquivoImportado(file)
                    .then(() => {
                        e.target.value = ''; // Limpar input
                    })
                    .catch(error => {
                        console.error('Erro no processamento:', error);
                        mostrarToast('Erro ao processar arquivo', 'erro');
                        e.target.value = '';
                    });
            }
        });
    }
}

// ========== INICIALIZAR SISTEMA DE BACKUP ==========

// Adicione esta linha na função inicializarApp():
async function inicializarApp() {
    configurarEventos();
    configurarEventosBackup(); // ← ADICIONE ESTA LINHA
    await carregarDadosIniciais();
    renderizarTabela();
    atualizarStatusBackup(); // ← E ESTA LINHA
}
    </script>
</body>
</html>